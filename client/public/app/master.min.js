var baseURL="/app/leaflet-color-markers/img";var blueIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-blue.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var redIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-red.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var greenIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-green.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var orangeIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-orange.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var yellowIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-yellow.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var violetIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-violet.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var greyIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-grey.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});var blackIcon=new L.Icon({iconUrl:baseURL+'/marker-icon-2x-black.png',shadowUrl:baseURL+'/marker-shadow.png',iconSize:[25,41],iconAnchor:[12,41],popupAnchor:[1,-34],shadowSize:[41,41]});"use strict";L.Control.Coordinates=L.Control.extend({options:{position:'bottomleft',latitudeText:'lat.',longitudeText:'lon.',promptText:'Press Ctrl+C to copy coordinates',precision:4},initialize:function(options)
{L.Control.prototype.initialize.call(this,options);},onAdd:function(map)
{var className='leaflet-control-coordinates',that=this,container=this._container=L.DomUtil.create('div',className);this.visible=false;L.DomUtil.addClass(container,'hidden');L.DomEvent.disableClickPropagation(container);this._addText(container,map);L.DomEvent.addListener(container,'click',function(){var lat=L.DomUtil.get(that._lat),lng=L.DomUtil.get(that._lng),latTextLen=this.options.latitudeText.length+1,lngTextLen=this.options.longitudeText.length+1,latTextIndex=lat.textContent.indexOf(this.options.latitudeText)+latTextLen,lngTextIndex=lng.textContent.indexOf(this.options.longitudeText)+lngTextLen,latCoordinate=lat.textContent.substr(latTextIndex),lngCoordinate=lng.textContent.substr(lngTextIndex);window.prompt(this.options.promptText,latCoordinate+' '+lngCoordinate);},this);return container;},_addText:function(container,context)
{this._lat=L.DomUtil.create('span','leaflet-control-coordinates-lat',container),this._lng=L.DomUtil.create('span','leaflet-control-coordinates-lng',container);return container;},setCoordinates:function(obj)
{if(!this.visible){L.DomUtil.removeClass(this._container,'hidden');}
if(obj.latlng){L.DomUtil.get(this._lat).innerHTML='<strong>'+this.options.latitudeText+':</strong> '+obj.latlng.lat.toFixed(this.options.precision).toString();L.DomUtil.get(this._lng).innerHTML='<strong>'+this.options.longitudeText+':</strong> '+obj.latlng.lng.toFixed(this.options.precision).toString();}}});function clipboardCopy(text){if(navigator.clipboard){return navigator.clipboard.writeText(text)}
var span=document.createElement('span')
span.textContent=text
span.style.whiteSpace='pre'
document.body.appendChild(span)
var selection=window.getSelection()
var range=window.document.createRange()
selection.removeAllRanges()
range.selectNode(span)
selection.addRange(range)
var success=false
try{success=window.document.execCommand('copy')}catch(err){console.log('error',err)}
selection.removeAllRanges()
window.document.body.removeChild(span)
return success?Promise.resolve():Promise.reject()}
function deleteAllCookies(){var cookies=document.cookie.split(";");for(var i=0;i<cookies.length;i++){var cookie=cookies[i];var eqPos=cookie.indexOf("=");var name=eqPos>-1?cookie.substr(0,eqPos):cookie;document.cookie=name+"=;expires=Thu, 01 Jan 1970 00:00:00 GMT";}}
function setCookie(name,value,days){var expires="";if(days){var date=new Date();date.setTime(date.getTime()+(days*24*60*60*1000));expires="; expires="+date.toUTCString();}
document.cookie=name+"="+(value||"")+expires+"; path=/";}
function getCookie(name){var nameEQ=name+"=";var ca=document.cookie.split(';');for(var i=0;i<ca.length;i++){var c=ca[i];while(c.charAt(0)==' ')c=c.substring(1,c.length);if(c.indexOf(nameEQ)==0)return c.substring(nameEQ.length,c.length);}
return null;}
function eraseCookie(name){document.cookie=name+'=; Max-Age=-99999999;';}
function parseQuery(queryString){var query={};var pairs=(queryString[0]==='?'?queryString.substr(1):queryString).split('&');for(var i=0;i<pairs.length;i++){var pair=pairs[i].split('=');query[decodeURIComponent(pair[0])]=decodeURIComponent(pair[1]||'');}
return query;}
function uuid(a){return a?(a^Math.random()*16>>a/4).toString(16):([1e7]+-1e3+-4e3+-8e3+-1e11).replace(/[018]/g,uuid)}
function testIsMobile(){var check=false;(function(a){if(/(android|bb\d+|meego).+mobile|avantgo|bada\/|blackberry|blazer|compal|elaine|fennec|hiptop|iemobile|ip(hone|od)|iris|kindle|lge |maemo|midp|mmp|mobile.+firefox|netfront|opera m(ob|in)i|palm( os)?|phone|p(ixi|re)\/|plucker|pocket|psp|series(4|6)0|symbian|treo|up\.(browser|link)|vodafone|wap|windows ce|xda|xiino/i.test(a)||/1207|6310|6590|3gso|4thp|50[1-6]i|770s|802s|a wa|abac|ac(er|oo|s\-)|ai(ko|rn)|al(av|ca|co)|amoi|an(ex|ny|yw)|aptu|ar(ch|go)|as(te|us)|attw|au(di|\-m|r |s )|avan|be(ck|ll|nq)|bi(lb|rd)|bl(ac|az)|br(e|v)w|bumb|bw\-(n|u)|c55\/|capi|ccwa|cdm\-|cell|chtm|cldc|cmd\-|co(mp|nd)|craw|da(it|ll|ng)|dbte|dc\-s|devi|dica|dmob|do(c|p)o|ds(12|\-d)|el(49|ai)|em(l2|ul)|er(ic|k0)|esl8|ez([4-7]0|os|wa|ze)|fetc|fly(\-|_)|g1 u|g560|gene|gf\-5|g\-mo|go(\.w|od)|gr(ad|un)|haie|hcit|hd\-(m|p|t)|hei\-|hi(pt|ta)|hp( i|ip)|hs\-c|ht(c(\-| |_|a|g|p|s|t)|tp)|hu(aw|tc)|i\-(20|go|ma)|i230|iac( |\-|\/)|ibro|idea|ig01|ikom|im1k|inno|ipaq|iris|ja(t|v)a|jbro|jemu|jigs|kddi|keji|kgt( |\/)|klon|kpt |kwc\-|kyo(c|k)|le(no|xi)|lg( g|\/(k|l|u)|50|54|\-[a-w])|libw|lynx|m1\-w|m3ga|m50\/|ma(te|ui|xo)|mc(01|21|ca)|m\-cr|me(rc|ri)|mi(o8|oa|ts)|mmef|mo(01|02|bi|de|do|t(\-| |o|v)|zz)|mt(50|p1|v )|mwbp|mywa|n10[0-2]|n20[2-3]|n30(0|2)|n50(0|2|5)|n7(0(0|1)|10)|ne((c|m)\-|on|tf|wf|wg|wt)|nok(6|i)|nzph|o2im|op(ti|wv)|oran|owg1|p800|pan(a|d|t)|pdxg|pg(13|\-([1-8]|c))|phil|pire|pl(ay|uc)|pn\-2|po(ck|rt|se)|prox|psio|pt\-g|qa\-a|qc(07|12|21|32|60|\-[2-7]|i\-)|qtek|r380|r600|raks|rim9|ro(ve|zo)|s55\/|sa(ge|ma|mm|ms|ny|va)|sc(01|h\-|oo|p\-)|sdk\/|se(c(\-|0|1)|47|mc|nd|ri)|sgh\-|shar|sie(\-|m)|sk\-0|sl(45|id)|sm(al|ar|b3|it|t5)|so(ft|ny)|sp(01|h\-|v\-|v )|sy(01|mb)|t2(18|50)|t6(00|10|18)|ta(gt|lk)|tcl\-|tdg\-|tel(i|m)|tim\-|t\-mo|to(pl|sh)|ts(70|m\-|m3|m5)|tx\-9|up(\.b|g1|si)|utst|v400|v750|veri|vi(rg|te)|vk(40|5[0-3]|\-v)|vm40|voda|vulc|vx(52|53|60|61|70|80|81|83|85|98)|w3c(\-| )|webc|whit|wi(g |nc|nw)|wmlb|wonu|x700|yas\-|your|zeto|zte\-/i.test(a.substr(0,4)))check=true;})(navigator.userAgent||navigator.vendor||window.opera);return check;}
var q=location.search?parseQuery(location.search):parseQuery(location.hash.substring(location.hash.indexOf("?")));var ismobile=q.fm||testIsMobile();function isMobile(){return ismobile;}
function scrollTo(node){return function(e){window.scroll&&node&&window.scroll({top:node.getBoundingClientRect().top+window.scrollY-20,behavior:'smooth',})}}
function dateComponent(opts){var inp=m("input",{class:"bt-calendar"});var picker;return{view:function(opts){var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;var isMobile=attrs.isMobile||false;if(!attrs.value&&attrs.bind){if(attrs.bind.p in attrs.bind.t){attrs.value=attrs.bind.t[attrs.bind.p]}}
if(readOnly){var t=moment(attrs.value).format("LL")
return m("div.datetime-cpnt.readonly",{},m("i.icon-calendar",{},""),m("label",{class:attrs.bind?attrs.bind.p:""},attrs.placeholder),m("span",{class:attrs.bind?attrs.bind.p:""},t))}
if(isMobile){return m("div.datetime-cpnt.mobile",{class:""},m("i.icon-calendar",{},""),m("input",{type:"datetime-local",value:!attrs.value?attrs.value:moment(attrs.value).format("YYYY-MM-DDTHH:mm:ss"),onchange:function(){if(this.value){var v=moment(this.value).format();attrs.bind&&(attrs.bind.t[attrs.bind.p]=v);}}},""));}
return m("div.datetime-cpnt",{class:""},m("i.icon-calendar",{},""),m("input",{type:"hidden",value:moment(attrs.value).format()},""),m("span.mui-date",{},[inp,]));},oncreate:function(vnode){if(isMobile()){return}
var attrs=vnode.attrs||{};var readOnly=attrs.readonly||false;if(readOnly){return}
var currentLocaleData=moment.localeData();picker=new Pikaday({defaultDate:new Date(),field:inp.dom,position:"bottom right",onSelect:function(e){attrs.value=e;if(attrs.bind){attrs.bind.t[attrs.bind.p]=e;}
attrs.onchange&&attrs.onchange(e);m.redraw()},i18n:{months:currentLocaleData.months(),weekdays:currentLocaleData.weekdays(),weekdaysShort:currentLocaleData.weekdaysShort()},format:currentLocaleData.longDateFormat("LL"),});picker.setDate(attrs.value||new Date())},onremove:function(opts){if(isMobile()){return}
var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;if(readOnly){return}
picker.destroy()},}}
function timeComponent(){return{view:function(opts){var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;var value=attrs.value||attrs.bind.t[attrs.bind.p];if(!value){value=new Date();value.setMinutes(00);}else if(!value.getHours){value=moment(value).toDate();}
hours=value.getHours();minutes=value.getMinutes();var out=new Date();out.setHours(hours);out.setMinutes((parseInt(minutes/10)*10));value.setMinutes((parseInt(minutes/10)*10));if(hours<10){hours="0"+hours;}
if(minutes<10){minutes="0"+minutes;}
if(readOnly){return m("div.time-cpnt.readonly",{},m("i.icon-clock",{},""),m("label",{},attrs.placeholder),m("span",{class:"hours"},hours),m("span",{},":"),m("span",{class:"minutes"},minutes))}
if(isMobile()){return m("div",{class:"time-cpnt"},[m("i.icon-clock",{},""),m("input",{type:"time",value:hours+":"+minutes,onchange:function(){if(this.value){var x=this.value.split(":")
hours=x[0];minutes=x[1];out.setHours(hours);out.setMinutes(minutes);attrs.bind&&(attrs.bind.t[attrs.bind.p]=out);}}},"")])}
var hopts=Array(24).fill().map(function(g,i){return m("option",{value:i},i)});var mopts=Array(60).fill().filter(function(g,i){return i%10===0;}).map(function(g,i){return m("option",{value:i*10},i*10)})
return m("div",{class:"time-cpnt"},[m("i.icon-clock",{},""),m("select",{class:"hours",selectedIndex:hours,onchange:function(e){hours=e.target.value;out.setHours(hours);attrs.bind&&(attrs.bind.t[attrs.bind.p]=out);attrs.onchange&&attrs.onchange(out);}},hopts),m("span",{},":"),m("select",{class:"minutes",selectedIndex:minutes/10,onchange:function(e){minutes=e.target.value;out.setMinutes(minutes);attrs.bind&&(attrs.bind.t[attrs.bind.p]=out);attrs.onchange&&attrs.onchange(out);}},mopts),]);}}}
var Text=function(){return{view:function(opts){var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;var value=attrs.value;if(!value&&attrs.bind){value=attrs.bind.t[attrs.bind.p];}
if(readOnly){return m("div.txt-cpnt.readonly",{},[m("label",{class:attrs.bind?attrs.bind.p:""},attrs.placeholder),m("span",{class:attrs.bind?attrs.bind.p:""},value),])}
var tagAttrs={value:value,onkeyup:function(e){if(attrs.bind){attrs.bind.t[attrs.bind.p]=e.target.value;}
attrs.value=e.target.value;attrs.onkeyup&&attrs.onkeyup(e);},placeholder:attrs.placeholder,readonly:attrs.readonly,}
if(attrs.bind){tagAttrs.name=attrs.bind.p;}
if(attrs.tagn!="textarea"){tagAttrs.type=attrs.type||"text";}
if(attrs.error){tagAttrs.class="error";}
if(attrs.required){tagAttrs.required=true;}
return m(attrs.tagn||"input",tagAttrs)},}}
var Checkbox=function(){return{view:function(opts){var attrs=opts.attrs||{};var divAttrs={class:"cb-cpnt",}
var labelAttrs={for:attrs.id,class:"",}
var cbAttrs={id:attrs.id,value:attrs.value,readonly:attrs.readonly,type:attrs.type||"checkbox",checked:false,}
if(attrs.error){divAttrs.class+=" error";}
if(attrs.required){cbAttrs.required=true;}
if(attrs.checked){cbAttrs.checked=!!attrs.checked;}
if(attrs.bind){cbAttrs.checked=!!attrs.bind.t[attrs.bind.p];}
if(attrs.id){cbAttrs.id=attrs.id;labelAttrs.for=attrs.id;}
if(attrs.readonly){labelAttrs.class+=" readonly";}
cbAttrs.onclick=function(e){attrs.onclick&&attrs.onclick(e,this.checked);}
cbAttrs.onchange=function(e){if(attrs.bind){attrs.bind.t[attrs.bind.p]=this.checked;}
attrs.onchange&&attrs.onchange(e,this.checked);}
return m("div",divAttrs,[!attrs.labelFirst?null:m("label",labelAttrs,attrs.placeholder),m("input",cbAttrs,""),attrs.labelFirst?null:m("label",labelAttrs,attrs.placeholder),])},}}
function txtF(model,prop,text,errP,opts){opts=opts||{};opts.placeholder=text;if(errP){opts.error=errP(prop);}
opts.bind={t:model,p:prop};return m(Text,opts)}
function txtA(model,prop,text,errP,opts){opts=opts||{};opts.placeholder=text;if(errP){opts.error=errP(prop);}
opts.bind={t:model,p:prop};opts.tagn="textarea"
return m(Text,opts)}
function dateF(model,prop,text,errP,opts){opts=opts||{};opts.placeholder=text;if(errP){opts.error=errP(prop);}
opts.bind={t:model,p:prop};return m(dateComponent,opts)}
function cbF(model,prop,text,errP,opts){opts=opts||{};opts.placeholder=text;if(errP){opts.error=errP(prop);}
opts.bind={t:model,p:prop};return m(Checkbox,opts)}
var Geocoder=function(opts){var attrs=opts.attrs||{};var id=attrs.id||"";var geoc=new L.Control.Geocoder.Nominatim({serviceUrl:"/geocode/"});var disabled=false;var tout;var value;var defaultText="saisissez une recherche...";var emptyRes="pas de resultats";var loadingRes="...en cours de chargement...";var viewRes="voir les résultats";var results=[{name:emptyRes}];var selectedIndex=0;var selectedValue=null;function fetchResults(value){if(disabled){return;}
disabled=true;selectedIndex=0;m.redraw();geoc.geocode(value,function(res){results=results.slice(0,1);res.map(function(v){results.push(v);});results[0].name=results.length>1?viewRes:emptyRes;disabled=false;m.redraw();},null)}
return{view:function(opts){var attrs=opts.attrs||{};var divAttrs={class:"geocoder-cpnt",id:id}
var inputAttrs={placeholder:defaultText,class:"column column-60",style:{display:"inline-block","max-width":"65%"},type:"text",value:value,onkeyup:function(){clearTimeout(tout);value=this.value;results[0].name=emptyRes;if(value.length){results[0].name=loadingRes;if(value.length>=4){tout=setTimeout(function(){fetchResults(value)},1050)}}else{results=results.splice(0,1);}}}
if(disabled){inputAttrs.disabled="disabled";}
var btSearchAttrs={class:"column column-20 float-right",style:{display:"inline-block","vertical-align":"bottom","padding":"0 1rem","max-width":"30%"},onclick:function(){if(value&&value.length>=4){fetchResults(value)}}}
var selectAttrs={disabled:results.length<2,selectedIndex:selectedIndex,onchange:function(e,i){selectedIndex=this.selectedIndex;selectedValue=this.selectedIndex==0?null:results[this.selectedIndex];attrs.onselect&&attrs.onselect(selectedValue,selectedIndex);}}
var btConfirmAttrs={disabled:selectedIndex<1,style:{"display":"block","width":"100%"},onclick:function(){attrs.onconfirm&&attrs.onconfirm(selectedValue)
selectedValue=null;selectedIndex=0;value="";results=results.slice(0,1)
results[0].name="pas de resultats"
m.redraw()}}
var confirmText=attrs.confirm;return m("div",divAttrs,[m("input",inputAttrs,""),m("button",btSearchAttrs,m("i",{class:"demo-icon icon-search"},"")),m("select",selectAttrs,results.map(function(v,i){return m('option',{value:""},v.name)})),!confirmText?null:m("button",btConfirmAttrs,confirmText),m("span",{},"license: Data © OpenStreetMap contributors, ODbL 1.0. https://osm.org/copyright"),])},}}
var CopyComponent=function(){var copied=false;return{view:function(opts){var attrs=opts.attrs||{};var value=attrs.value;var inputAttrs={type:"text",readonly:true,}
var btnAttrs={class:"icon-clipboard"}
var c="copy-cpnt";if(copied){c+=" copied";}
return m("div",{class:c,onclick:function(){clipboardCopy(attrs.value);copied=true;m.redraw();setTimeout(function(){copied=false;m.redraw();},1000*5)}},[m("input",inputAttrs),m("div",{class:"content"},attrs.value),m("div",{class:"extra"},[m("span",{},copied?"texte copié!":"cliquez pour copier"),m("i",{class:"icon-clipboard"})]),])},}}
var ProtestsListComponent=function(){return{view:function(vnode){var protests=vnode.attrs.protests||[];var onclick=vnode.attrs.onclick||null;return m("div",{class:"protests-cpnt"},m("table",{},m("tr",{},m("th",{},"Public"),m("th",{},"Titre"),m("th",{},"Date"),m("th",{},"Lieu")),protests.map(function(v){var steps=v.steps||[];return m("tr",{onclick:function(e){onclick&&onclick(v);}},m("td",{},v.public?"oui":"non"),m("td",{},v.title),m("td",{},moment(v.gather_at).format("LL")),m("td",{},steps.length?steps[0].place:"-"))})))},}}
var ContactsListComponent=function(){return{view:function(vnode){var messages=vnode.attrs.messages||[];var onclick=vnode.attrs.onclick||null;return m("div",{class:"contacts-cpnt"},m("table",{},m("tr",{},m("th",{},"Date"),m("th",{},"Sujet"),m("th",{},"Contact"),m("th",{},"Message")),messages.map(function(v){return m("tr",{onclick:function(e){onclick&&onclick(v);}},m("td",{},moment(v.created_at).format("LL")),m("td",{},v.subject),m("td",{},v.returnaddr),m("td",{},v.body.substring(20)+"..."))})))},}}
var ContactViewComponent=function(){return{view:function(vnode){var attrs=vnode.attrs||{};var message=attrs.message||[];var onreturn=attrs.onreturn||null;var ontrash=attrs.ontrash||null;return m("div",{class:"contact-cpnt"},m("div",{},m("span",{},"Date"),moment(message.created_at).format("LL")),m("div",{},m("span",{},"Contact"),message.returnaddr),m("div",{},m("span",{},"Sujet"),message.subject),m("div",{},m("span",{},"Message"),m("br"),message.body),m("br"),m("br"),m("div",{},m("button",{onclick:function(e){onreturn&&onreturn(message,e);},class:"bt-back"},"retour"),m("button",{onclick:function(e){ontrash&&ontrash(message,e);},class:"bt-trash"},m("i",{class:"icon-trash-empty"},""))))},}}
var ProtestComponent=function(){function doPrint(){document.body.classList.add("print")
window.print();document.body.classList.remove("print")
return false;}
return{view:function(opts){var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;var model=attrs.model||{};var errModel=attrs.errModel||{};var protestError=errorReader("protest",errModel)
if(!('public'in model)){model.public=true;}
var cbText="Ce parcours est public:";return m("div",{class:"protest-cpnt"},!readOnly?null:m("i",{class:"print-it icon-print",onclick:doPrint},""),txtF(model,"title","Titre",protestError,{readonly:readOnly}),txtF(model,"organizer","Organisateur",protestError,{readonly:readOnly}),dateF(model,"gather_at","Date",protestError,{readonly:readOnly,isMobile:isMobile()}),txtF(model,"protest","Mouvement",protestError,{readonly:readOnly}),m("br"),txtA(model,"description","Description",protestError,{readonly:readOnly,style:{width:"450px",resize:"none"}}),m("br"),m("div",{class:"publicpath"},!readOnly?null:m("b",{},cbText),!readOnly?null:m("span",{},model.public?"oui":"non"),readOnly?null:cbF(model,"public",cbText,protestError,{id:"publiccb",readonly:readOnly,labelFirst:true})),readOnly?null:m("div",{style:{display:model.public?"none":"block"}},txtF(model,"password","Mot de passe pour accéder à ce parcours",protestError,{})),m("br"))},}}
var MapComponent=function(opts){var mymap=null;var provider=L.tileLayer('https://{s}.tile.openstreetmap.fr/osmfr/{z}/{x}/{y}.png',{maxZoom:20,attribution:'&copy; Openstreetmap France | &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'});var c=new L.Control.Coordinates();var startPt=[48.8630,2.3456];var line=null;var dragend=function(step){return function(event){var position=event.target.getLatLng();step.lat=position.lat;step.lng=position.lng;m.redraw();}}
var drawPath=function(model){var coords=[];model.steps.map(function(v){coords.push([v.lat,v.lng]);v.marker.addTo(mymap);v.marker.off('dragend');v.marker.on('dragend',dragend(v));});if(coords.length>1){if(line===null){line=L.polyline(coords);line.addTo(mymap);}else{line.setLatLngs(coords)}}else if(line!==null){line.removeFrom(mymap)
line=null;}}
return{map:null,view:function(vnode){var attrs=vnode.attrs||{};var model=attrs.model||{};var readOnly=attrs.readonly||false;if(mymap){model.updateMarkers(mymap,dragend,readOnly);drawPath(model);if(model.startPt){mymap.setView(model.startPt,13);delete model.startPt;}}
return m("div",{class:"map-container"},"")},oncreate:function(vnode){var attrs=vnode.attrs||{};var model=attrs.model||{};var readOnly=attrs.readonly||false;mymap=L.map(vnode.dom).setView(startPt,13);provider.addTo(mymap);c.addTo(mymap);this.map=mymap;mymap.on('click',function(e){e.originalEvent.preventDefault();var t=e.originalEvent.target;if(t.classList.contains("leaflet-marker-icon")){if(model.isHighlightedByIcon(t)){model.unHighLightAll();}else{model.unHighLightAll();model.highlightByIcon(t);}
m.redraw();return false;}
if(model.hasHighLights()){model.unHighLightAll()
m.redraw();return}
if(readOnly)return;model.addStep(e.latlng.lat,e.latlng.lng);model.updateMarkers(mymap,dragend,readOnly);drawPath(model);c.setCoordinates(e);m.redraw();});model.updateMarkers(mymap,dragend,readOnly);drawPath(model);m.redraw();},onremove:function(vnode){var attrs=vnode.attrs||{};var model=attrs.model||{};model.steps.map(function(v){v.marker.remove();})
mymap.remove();},}}
var StepsComponent=function(){return{view:function(opts){var attrs=opts.attrs||{};var readOnly=attrs.readonly||false;var model=attrs.model||{};var errModel=attrs.errModel||{};var stepsError=errorReader("protest.steps",errModel);var hasHL=model.hasHighLights();var modelShowAll={checked:!hasHL,}
var stepsClass="steps"
if(hasHL){stepsClass+=" hl"}
var cbClick=function(e,checked){checked&&model.unHighLightAll();}
var cbShowAll=cbF(modelShowAll,"checked","afficher toutes les étapes",null,{id:"show-steps",onclick:cbClick,labelFirst:true,readonly:!hasHL});return m("div",{class:"leftpanel"},m("div",{class:"bkgw"},""),m("div",{class:"leftpanel-container"},[m("h3",{},"vos étapes",m("span",{},"("+(model.wholeDistance().toFixed(2))+" km)")),model.steps.length<2?null:cbShowAll,model.steps.length>0?null:m("div",{onclick:scrollTo(document.getElementById("geocoder")),},m.trust("cliquez sur la <b>carte</b> ou utilisez le <b>geocoder</b> pour ajouter de nouveaux points de rendez vous.")),m("div",{class:stepsClass},model.steps.map(function(v,i){var c="step ";if(hasHL){if(!v.highlight){c+=" hide";}else{c+=" hl";}}
return m("div",{class:c},[m("h5",{onclick:function(e){if(!readOnly){model.unHighLightAll()
model.hightlightAtIndex(i);var step=model.steps[i];model.startPt=[step.lat,step.lng];m.redraw();}}},"étape n°"+(i+1)),m(timeComponent,{readonly:readOnly,placeholder:"Heure",bind:{t:v,p:"gather_at"},error:stepsError(i,"gather_at")}),m(Text,{readonly:readOnly,placeholder:"lieu",bind:{t:v,p:"place"},error:stepsError(i,"place"),maxlength:190}),m(Text,{readonly:readOnly,tagn:"textarea",placeholder:"details",bind:{t:v,p:"details"},error:stepsError(i,"details"),maxlength:190}),i<1?null:m("div",{class:"dist"},[m("span",{},(v.dist.toFixed(2))+" km depuis l'étape précédente"),]),m("div",{class:"latlng"},[m("span",{},"lat:"+(v.lat.toFixed(4))),m("span",{},"lng:"+(v.lng.toFixed(4))),]),readOnly?null:m("div",{style:{"text-align":"right"}},m("button",{onclick:function(e){model.rmStepAtIndex(i);},class:"rm-step",},m("i",{class:"icon-trash-empty"},""))),])})),]))},}}
var ftomate=document.getElementsByName("ftomate")[0].value;function errorReader(prefix,model){return function(){var args=Array.prototype.slice.call(arguments);var path=args.map(function(x){if(x===parseInt(x,10)){return "["+x+"]";}
return "."+x;}).join("");path=""+prefix+""+path;return model[path]||"";}}
function protestModel(){this.id=null;this.title="";this.protest="";this.organizer="";this.password="";this.gather_at=null;this.public=true;this.steps=[];this.updateMarkers=function(map,dragend,ro){var steps=this.steps;steps.map(function(v,i){if(!v.marker||!v.marker.addTo){v.marker=L.marker([v.lat,v.lng],{bubblingMouseEvents:false,draggable:!ro});v.marker.on('dragend',dragend(v));}
if(v.highlight){v.marker.setIcon(yellowIcon)}else{v.marker.setIcon(blueIcon)}
v.marker.addTo(map);v.dist=0;if(i>0){var from=steps[i-1].marker.getLatLng();var to=v.marker.getLatLng();v.dist=(from.distanceTo(to)/1000)}})};this.highlightByIcon=function(domIcon){this.steps.map(function(v){if(v.marker&&v.marker._icon==domIcon){v.highlight=true;v.marker.setIcon(yellowIcon);}})};this.isHighlightedByIcon=function(domIcon){var i=false;this.steps.map(function(v){if(v.marker&&v.marker._icon==domIcon){i=v.highlight;}})
return i};this.hightlightAtIndex=function(i){if(this.steps[i]){this.steps[i].title="hled";this.steps[i].highlight=true;this.steps[i].marker.setIcon(yellowIcon);}};this.hasHighLights=function(){return this.steps.filter(function(v){return v.highlight;}).map(function(v){return v.highlight;}).length>0;};this.unHighLightAll=function(){this.steps.map(function(v){v.marker.setIcon(blueIcon)
v.highlight=false;})};this.addStep=function(lat,lng){var step={lat:lat,lng:lng,title:"",gather_at:new Date(),details:"",highlight:false,dist:0,marker:null,};this.steps.push(step);return step;};this.rmStepAtIndex=function(i){if(this.steps[i]){this.steps[i].marker.remove();this.steps.splice(i,1);}};this.wholeDistance=function(i){var d=0.0;this.steps.map(function(v){d+=v.dist;})
return d;};this.reset=function(){this.title="";this.protest="";this.description="";this.organizer="";this.gather_at=null;this.public=true;this.password="";this.steps=[];this.steps.map(function(v){this.steps.push({lat:v.lat,lng:v.lng,place:v.place,gather_at:v.gather_at,details:v.details,})})}
this.setData=function(data){this.id=data.id||0;this.title=data.title||"";this.protest=data.protest||"";this.description=data.description||"";this.organizer=data.organizer||"";this.gather_at=data.gather_at||null;this.public=!!data.public;this.password=data.password||"";this.steps=[];var that=this;(data.steps||[]).map(function(v){that.steps.push({lat:v.lat,lng:v.lng,place:v.place,gather_at:v.gather_at,details:v.details,dist:0.0,})})}}
var myModel={RW:new protestModel(),RO:new protestModel(),selectedMessage:{},}
var myAPI={createProtest:function(data){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/protests/create",data:data,withCredentials:true,headers:{"X-tomate":ftomate}}).then(resolve).catch(function(e){console.log(e);reject(e);})})},getProtestByID:function(id){return new Promise(function(resolve,reject){m.request({method:"GET",url:"/protests/"+id,headers:{"X-tomate":ftomate},}).then(resolve).catch(function(e){console.log(e);reject(e);})})},getProtestByIDAndPwd:function(id,password){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/protests/"+id,data:{pwd:password},headers:{"X-tomate":ftomate},}).then(resolve).catch(function(e){console.log(e);reject(e);})})},getProtestsByAuthor:function(id){return new Promise(function(resolve,reject){m.request({method:"GET",url:"/protests/by_author/"+id,}).then(resolve).catch(function(e){console.log(e);reject(e);})})},searchProtests:function(data){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/protests/search",headers:{"X-tomate":ftomate},data:data}).then(resolve).catch(function(e){console.log(e);reject(e);})})},login:function(model){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/admin/login",headers:{"X-tomate":ftomate},data:model,}).then(resolve).catch(function(e){console.log(e);reject(e);})})},captchaNew:function(){return new Promise(function(resolve,reject){m.request({url:"/captcha/new",headers:{"X-tomate":ftomate},}).then(resolve).catch(function(e){console.log(e);reject(e);})})},createContact:function(data){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/contacts/create",headers:{"X-tomate":ftomate},data:data,}).then(resolve).catch(function(e){console.log(e);reject(e);})})},getContacts:function(){return new Promise(function(resolve,reject){m.request({method:"GET",url:"/contacts/list",headers:{"X-tomate":ftomate},}).then(resolve).catch(function(e){console.log(e);reject(e);})})},delContact:function(id){return new Promise(function(resolve,reject){m.request({method:"POST",url:"/contacts/delete/"+id,headers:{"X-tomate":ftomate}}).then(resolve).catch(function(e){console.log(e);reject(e);})})},}
function Head(menu){var open=false;var onbodyClick=function(){open=false;m.redraw();}
return{view:function(){var path=(location.hash||"#!"+Object.keys(menu)[0]).substr(2);var c="menu";if(open){c+=" open"}
return[m("h1",{class:"title"},"Mon parcours"),m("div",{class:c},m("div",{class:"bg"},""),m("i",{class:"icon icon-list-nested",onclick:function(e){open=!open;m.redraw();return false;}},""),m("dl",{},Object.keys(menu).map(function(key){var c=key==path?"hl":"";return m("dt",m("a",{href:"#!"+key,class:c,onclick:function(e){open=false;}},menu[key]))})))]},oncreate:function(){document.getElementById("body").addEventListener("click",onbodyClick,false)},onremove:function(){document.getElementById("body").removeEventListener("click",onbodyClick)}}}
function Foot(menu){return{view:function(){var path=(location.hash||"#!"+Object.keys(menu)[0]).substr(2);var c="foot";return m("div",{class:c},m("dl",{},Object.keys(menu).map(function(key){var c=key==path?"hl":"";return m("dt",m("a",{href:"#!"+key,class:c,onclick:function(e){open=false;}},menu[key]))})))}}}
var WelcomePage={view:function(){var content=document.getElementById("text-accueil").innerHTML;return m("div",{class:"column"},m.trust(content))}}
var CreatePage=function(){var model=myModel.RW;var errModel={};var mymap={};var geocMarker=L.marker([0,0],{bubblingMouseEvents:false,draggable:false});return{view:function(opts){var map=m(MapComponent,{model:model,readonly:false});var protest=m(ProtestComponent,{model:model,errModel:errModel,readonly:false});var geocoder=m(Geocoder,{id:"geocoder",onselect:function(v){if(v&&v.name){var coords=[v.properties.lat,v.properties.lon];geocMarker.setLatLng(coords);geocMarker.addTo(map.state.map);map.state.map.setView(coords,13);}else{geocMarker.remove();}
m.redraw();},confirm:"créer une étape",onconfirm:function(v){geocMarker.remove();var lat=parseFloat(v.properties.lat)
var lon=parseFloat(v.properties.lon)
var step=model.addStep(lat,lon);step.marker=L.marker([lat,lon],{bubblingMouseEvents:false,draggable:true});step.place=v.name;step.gather_at=new Date();m.redraw();}});var steps=m(StepsComponent,{model:model,errModel:errModel,readonly:false});var save=function(e){var btn=e.target;btn.disabled=true;myModel.RO.setData(model)
myModel.RO.author_id=getCookie("rnd");e.preventDefault();errModel={};myAPI.createProtest(myModel.RO).then(function(data){btn.disabled=false;errModel={};model.reset()
myModel.RO.reset()
myModel.RO.setData(data)
self.location="#!/voir/"+data.id;}).catch(function(err){btn.disabled=false;errModel=err.response||{};m.redraw();})
return false;}
return m("div",{class:"column page-create"},[protest,geocoder,m("div",{style:{position:"relative"}},[map,steps]),m("button",{class:"button bt-save float-right",disabled:model.steps.length<1,onclick:save,},"sauvegarder")])},}}
var ViewPage=function(){var model=myModel.RO;var pwdModel={password:""}
return{oninit:function(opts){var attrs=opts.attrs||{};myAPI.getProtestByID(attrs.id).then(function(data){model.steps.map(function(v){v.marker.remove();})
model.setData(data);if(model.steps.length)model.startPt=[model.steps[0].lat,model.steps[0].lng];m.redraw();})},view:function(opts){var attrs=opts.attrs||{};function checkPwd(e){myAPI.getProtestByIDAndPwd(attrs.id,pwdModel.password).then(function(data){model.setData(data);m.redraw()})}
if(model.id==-1){return m("div",{class:"column page-view"},m("div",{class:"require-pwd"},m("label",{},""),txtF(pwdModel,"password","Mot de passe",null,{}),m("button",{onclick:checkPwd},"soumettre")))}
return m("div",{class:"column page-view"},[m(CopyComponent,{value:location.toString()}),m(ProtestComponent,{model:model,readonly:true}),m("div",{style:{position:"relative"}},[m(MapComponent,{model:model,readonly:true}),m(StepsComponent,{model:model,readonly:true})]),]);},}}
var NoticePage=function(){var content=document.getElementById("text-notice");return{view:function(){return m("div",{class:"column page-notice"},m.trust(content.innerHTML))},oncreate:function(){var ifr=document.createElement("iframe");ifr.setAttribute("width","560")
ifr.setAttribute("height","315")
ifr.setAttribute("frameborder","0")
ifr.setAttribute("src","https://www.youtube-nocookie.com/embed/brsJwdH9dso?start=314")
ifr.setAttribute("allow","accelerometer; autoplay; encrypted-media; gyroscope; picture-in-picture")
ifr.setAttribute("allowfullscreen","")
document.querySelector(".page-notice #yt").appendChild(ifr);},}}
var MinesPage=function(){var model=[];var onclick=function(v){window.location="#!/voir/"+v.id;};return{oninit:function(vnode){myAPI.getProtestsByAuthor(getCookie("rnd")).then(function(data){model.splice(0)
data.map(function(v){model.push(v)})
m.redraw()})},view:function(){var emptyRes=m("div",{class:"empty"},m("h3",{},"il n'y a pas de résultats"));var protests=m(ProtestsListComponent,{protests:model,onclick:onclick});return m("div",{class:"column page-mines"},model.length<1?null:protests,model.length>0?null:emptyRes)}}}
var SearchPage=function(){var model={title:"",protest:"",organizer:"",date_start:moment().subtract(7,'days').toDate(),date_end:moment().add(14,'days').toDate(),lat:0,log:0}
var onclick=function(v){window.open("#!/voir/"+v.id);}
var results=[];var hasSearched=false;return{view:function(){var geocoder=m(Geocoder,{id:"geocoder",onselect:function(v){model.lat=parseFloat(v.properties.lat);model.lng=parseFloat(v.properties.lon);m.redraw();}});var search=function(){hasSearched=true;var data={};if(model.title){data.title=model.title;}
if(model.protest){data.protest=model.protest;}
if(model.organizer){data.organizer=model.organizer;}
if(model.date_start){data.date_start=model.date_start;}
if(model.date_end){data.date_end=model.date_end;}
if(model.lat){data.lat=model.lat;}
if(model.lng){data.lng=model.lng;}
myAPI.searchProtests(data).then(function(data){results.splice(0)
data.map(function(v){results.push(v);})
m.redraw()})}
var emptyRes=m("div",{class:"empty"},m("h3",{},"il n'y a pas de résultats"));var protests=m("div",{class:"results"},m(ProtestsListComponent,{protests:results,onclick:onclick}));return m("div",{class:"column page-search"},m("div",{},"saisissez des critères pour effectuer une recherche"),txtF(model,"title","Titre",null,{}),txtF(model,"organizer","Organisateur",null,{}),txtF(model,"protest","Mouvement",null,{}),dateF(model,"date_start","Debut de période",null,{isMobile:isMobile()}),dateF(model,"date_end","Fin de période",null,{isMobile:isMobile()}),geocoder,m("button",{class:"bt-save",onclick:search},"rechercher"),hasSearched&&results.length<1?emptyRes:null,results.length<1?null:protests)},}}
var ContactPage=function(){var model={returnaddr:"",subject:"",body:"",captchaid:"",captchasolution:"",}
var errModel={}
var confirmed=false;var updateCaptcha=function(){return myAPI.captchaNew().then(function(data){model.captchaid=data.id;model.captchasolution="";m.redraw()})}
return{oninit:updateCaptcha,view:function(){if(confirmed){return m("div",{class:"column page-contact"},m("h2",{class:"ok"},"Votre demande de contact est enregistrée, merci!"))}
var contactError=errorReader("contactmessageinput.contactmessage",errModel)
var captchaError=errorReader("contactmessageinput.captchainput",errModel)
var send=function(e){var btn=e.target;btn.disabled=true;errModel={};myAPI.createContact(model).then(function(data){errModel={};confirmed=true;btn.disabled=false;updateCaptcha()
m.redraw()}).catch(function(e){btn.disabled=false;errModel=e.response;updateCaptcha()
m.redraw()})}
return m("div",{class:"column page-contact"},m("div",{},"saisissez votre demande de contact"),txtF(model,"returnaddr","Adresse de retour",contactError,{}),txtF(model,"subject","Sujet",contactError,{}),txtA(model,"body","Message",contactError,{}),m("div",{},[m("div",{},"saisissez le captcha"),m("input",{type:"hidden",value:model.captchaid},""),m("img",{src:"/captcha/"+model.captchaid+".png"},""),txtF(model,"captchasolution","Solution au captcha",captchaError,{}),]),m("button",{class:"bt-save",onclick:send,},"envoyer"))},}}
var AdminPage=function(){var model={key:"",}
var errModel={}
var confirmed=false;return{view:function(){var contactError=errorReader("login",errModel);if(confirmed){return m("div",{class:"column page-admin"},[m("h3",{class:"ok"},"Vous êtes connecté.")])}
var login=function(e){var btn=e.target;btn.disabled=true;errModel={};confirmed=false;myAPI.login(model).then(function(data){confirmed=true;errModel={};btn.disabled=false;m.redraw()}).catch(function(e){btn.disabled=false;if(e.response)errModel=e.response;m.redraw()});}
return m("div",{class:"column page-admin"},m("div",{},"saisissez votre clef"),txtA(model,"key","Clef",contactError,{}),m("button",{class:"bt-save",onclick:login},"connexion"))},}}
var ContactsPage=function(){var messages=[];var onclick=function(v){myModel.selectedMessage=v;window.location="#!/contacts/voir/"+v.id;};return{oninit:function(){myAPI.getContacts().then(function(data){messages.splice(0)
data.map(function(v){messages.push(v)})
m.redraw()})},view:function(){return m("div",{class:"column page-contacts"},m(ContactsListComponent,{messages:messages,onclick:onclick}))}}}
var ContactViewPage=function(){var onreturn=function(v){window.location="#!/contacts/";};var ontrash=function(v){myAPI.delContact(v.id).then(function(data){myModel.selectedMessage={};onreturn()})};return{view:function(){return m("div",{class:"column page-viewcontact"},m(ContactViewComponent,{message:myModel.selectedMessage,onreturn:onreturn,ontrash:ontrash}))}}}
var getNavigatorLanguage=function(){if(navigator.languages&&navigator.languages.length){return navigator.languages[0];}else{return navigator.userLanguage||navigator.language||navigator.browserLanguage||'en';}}
moment.locale(getNavigatorLanguage());if(getCookie("rnd")===null){setCookie("rnd",uuid(),30)}else{setCookie("rnd",getCookie("rnd"),30)}
var q=location.search?parseQuery(location.search):parseQuery(location.hash.substring(location.hash.indexOf("?")));var isadmin=q.ia||getCookie("ia");if(isadmin){setCookie("ia","true",30)}
var menuHead={"/accueil":"Accueil","/creer":"Créer un parcours","/mes-parcours":"Mes parcours","/rechercher":"Rechercher","/avant-de-partir":"Avant de partir..."};if(isadmin){menuHead["/admin"]="Admin";}
var menuFoot={"/contact":"Contact"};if(isadmin){menuFoot["/contacts"]="Contacts";}
var pages={"/accueil":WelcomePage,"/creer":CreatePage,"/mes-parcours":MinesPage,"/rechercher":SearchPage,"/voir/:id":ViewPage,"/avant-de-partir":NoticePage,"/contact":ContactPage}
if(isadmin){pages["/admin"]=AdminPage;pages["/contacts"]=ContactsPage;pages["/contacts/voir/:id"]=ContactViewPage;}
m.mount(document.getElementById("head"),Head(menuHead))
m.mount(document.getElementById("foot"),Foot(menuFoot))
m.route(document.getElementById("body"),"/accueil",pages)